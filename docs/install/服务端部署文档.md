# 服务端部署文档

## 部署目标

本文档用于在一台 Linux 服务器上完成 **HuLa-Server（后端）+ 基础依赖服务（MySQL / Redis / RocketMQ / Nacos / Jenkins 等）** 的部署与启动。

> [!NOTE]
> 文档中的路径以示例 `/home/docker`、`/home/jenkins/work` 为准；若你使用其他路径，请保持 **docker-compose、Jenkins Workspace、脚本路径** 三者一致。

## 前置条件（务必确认）

- **服务器**：Linux（推荐 Ubuntu / Debian / CentOS 均可）
- **软件**：Docker、Docker Compose（或 Docker Compose v2）
- **权限**：可使用 `sudo`

> [!TIP]
> 如果你用的是云服务器：需要同时在 **云厂商安全组** 与 **服务器防火墙/面板（1panel、宝塔等）** 放行端口，否则容器起来了也访问不到。

## 端口放行清单（建议先做）

> [!WARNING]
> 实际端口以你的 `docker-compose.yml` / 配置文件为准；以下为常见默认值与本文提到的端口。

- **Jenkins**：`20000`（本文示例）
- **RocketMQ**：`10911`（Broker 通信端口，运行项目时会用到）
- **MySQL / Redis / Nacos / RocketMQ Console 等**：按 `docker-compose.yml` 中映射端口放行

## 一、部署基础服务（Docker）

### 1. 上传部署目录

将仓库内的 `docs/install/docker/` 整个目录上传到服务器，并放到：

- **目标目录**：`/home/docker`

最终效果示例：

```bash
/home/docker/docker-compose.yml
/home/docker/env/
/home/docker/rocketmq/
...
```

### 2. 修改关键配置

1. 修改环境变量（按需）：

- `/home/docker/env/` 下的各类 `*.env`

1. 修改 RocketMQ 配置（必做）：

- 重点文件：`/home/docker/rocketmq/broker/conf/broker.conf`
- **必须修改**：`brokerIP1` 为你的服务器 **对外可达 IP**

> [!NOTE]
> 如果 `brokerIP1` 不正确，常见现象是：服务启动成功但消息收发异常、客户端连接失败等。

### 3. 启动基础服务

#### 3.1 给 RocketMQ 目录授权（避免写入失败）

```bash
sudo chmod -R 777 /home/docker/rocketmq
```

#### 3.2 启动容器

```bash
cd /home/docker && docker-compose up -d
```

> [!TIP]
> 你可以用 `docker ps` 查看容器是否全部启动；用 `docker logs <容器名>` 查看启动失败原因。

### 4. 初始化 Nacos 数据库（否则 Nacos 可能无法启动）

需要导入 Nacos 的数据库表结构：

- SQL 文件：`docs/install/mysql-schema.sql`

> [!NOTE]
> 将该 SQL 导入到你的 MySQL 后再重启 Nacos，通常可解决 “Nacos 起不来/一直重启” 的问题。

#### 4.1 重启 Nacos（如需要）

如果导入后仍异常，可删除 Nacos 容器并重建：

```bash
docker rm -f nacos
cd /home/docker && docker-compose up -d
```

> [!WARNING]
> 容器名不一定叫 `nacos`，以你 `docker ps` 看到的名称为准。

### 5. 部署效果预览

![环境部署效果.png](image/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%88%E6%9E%9C.png)

## 二、注册邮箱功能（可选，但注册会用到）

在项目配置中填写邮箱相关密钥/账号信息（以你项目实际配置项为准）：

![login.png](image/login.png)

> [!TIP]
> 如果你只做本地自测，可先关闭注册邮箱校验或使用测试邮箱；生产环境务必使用专用邮箱账号与授权码。

## 三、安装构建环境（宿主机）

### 1. 放行 Jenkins 端口

- 云安全组 + 服务器防火墙/面板：放行 `20000`（或你自己的 Jenkins 端口）

### 2. 安装 JDK 21

- 下载：`https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz`
- 安装位置：宿主机（非容器内）

### 3. 安装 Git、Maven

- Git：系统自带或自行安装
- Maven：下载 `https://maven.apache.org/download.cgi`，上传到服务器解压即可

> [!NOTE]
> 后续 Jenkins 会使用 Maven 构建，请确保 Maven 可用且路径配置正确。

## 四、Jenkins 配置（用于持续构建/部署）

### 1. 获取初始密码并登录

查看初始管理员密码：

```bash
docker logs -f jenkins | grep "initialAdminPassword"
```

![jenkins密码.png](image/jenkins%E5%AF%86%E7%A0%81.png)

浏览器打开（示例）：

- `http://<服务器IP>:20000`

输入上一步密码，完成初始化向导。

### 2. 安装必要插件

进入插件管理页面：

- `http://<服务器IP>:20000/manage/pluginManager/`

安装（或确认已安装）：

```text
Git Parameter
Git plugin
Maven Integration
gitee
Publish Over SSH
```

### 3. 全局配置：环境变量、代码仓库与凭证

进入系统配置：

- `http://<服务器IP>:20000/manage/configure`

#### 3.1 配置 PATH（示例）

```text
PATH
/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/var/jenkins_home/maven/bin:/root/bin
```

![img.png](image/img.png)

#### 3.2 配置仓库地址与凭证（重要）

在同一页面配置项目地址与凭证：

- **凭证类型**：必须选择 `giteeAPI`
- **仓库**：`util`、`cloud` 两个项目地址都需要配置
- **测试连接**：点击“测试连接”必须返回成功

![img_2.png](image/img_2.png)
![img_1.png](image/img_1.png)

### 4. 全局工具配置：配置 Jenkins 内 Maven

进入工具配置：

- `http://<服务器IP>:20000/manage/configureTools/`

将宿主机下载的 Maven 解压到（示例）：

- `/home/jenkins/work/`

然后在 Jenkins 工具里指向该 Maven。

![img_4.png](image/img_4.png)
![img_3.png](image/img_3.png)

## 五、创建流水线（util、cloud）

### 1. 创建 util 流水线

- 新建任务：输入名称，选择“流水线”

![img_8.png](image/img_8.png)

- 按图配置 pipeline（请逐项核对）

![img_6.png](image/img_6.png)

#### 创建账号凭证（注意）

> [!WARNING]
> 这里创建的账号是 **username/password（你登录 gitee 的账号密码）**，不是 apikey。

![img_5.png](image/img_5.png)

### 2. 创建 cloud 流水线

![img_7.png](image/img_7.png)

按图配置 pipeline（请逐项核对）：

![img_9.png](image/img_9.png)

## 六、编译顺序（必须先 util 后 cloud）

> [!NOTE]
> 因为 `cloud` 依赖 `util`，必须先将 `util` 安装到 Maven 本地仓库。

### 1. 构建并 install util

![img.png](image/img_11.png)

### 2. 构建并 install cloud

![img_1.png](image/img_10.png)

## 七、运行项目

### 1. RocketMQ 目录授权（避免写入失败）

```bash
chmod 777 /home/docker/rocketmq/broker/logs
chmod 777 /home/docker/rocketmq/broker/store
chmod 777 /home/docker/rocketmq/namesrv/logs
chmod 777 /home/docker/rocketmq/namesrv/store
```

### 2. 导入业务数据库

导入以下数据库（以你提供的 SQL/备份为准）：

- `luohuo_im_01`
- `luohuo_dev`

### 3. 启动脚本

```bash
/bin/bash /home/jenkins/work/workspace/luohuo-cloud/src/main/bin/all-start.sh
```

![img_3.png](image/img_12.png)

### 4. RocketMQ 连接模式注意事项

> [!WARNING]
> 消息推送采用 **CLUSTERING** 模式：**单个 MQ 的同一个消费组，只能被一个 cloud 实例有效消费**。  
> 如果你同时启动多个 cloud，可能出现 “消息收不到/被别的实例消费” 的现象。

若需要多次连接/多套环境，建议单独再起一套 RocketMQ 测试版：

- 目录：`docs/install/rocketmqtest/`
- 操作：复制到服务器后执行 `docker-compose up -d`

## 八、本地视频/语音通话（开发调试）

Chrome 需要将非 HTTPS 的源视为安全来源：

1. 打开：

- `chrome://flags/`

1. 搜索并配置：

- `Insecure origins treated as secure`

1. 填入允许的来源（示例）：

- `http://192.168.1.37:6130`
- `http://192.168.1.24:6130`
- `http://192.168.1.26:6130`
